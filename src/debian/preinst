#!/bin/bash
#--------------------------------------
# Script Name:  preinst
# Version:      1.0
# Authors:      akombeiz@ukaachen.de
# Date:         30 Oct 24
# Purpose:      Pre-installation script for 'aktin-notaufnahme-i2b2'.
#               Checks for dependencies, prepares backups, and stops conflicting services if upgrading.
#--------------------------------------

readonly OPERATION="${1}"

check_ubuntu_version() {
  local ubuntu_version
  ubuntu_version=$(lsb_release -rs)
  if [[ "${ubuntu_version}" != "__UBUNTU_VERSION__" ]]; then
    echo "Warning: This package is optimized for Ubuntu __UBUNTU_VERSION__. Detected version: ${ubuntu_version}"
  fi
}

check_dependencies() {
  echo "Checking required services..."
  local required_services=("postgresql" "apache2")
  for service in "${required_services[@]}"; do
    if ! systemctl is-active --quiet "${service}"; then
      echo "Error: ${service} is not running. Please ensure it is installed and configured before proceeding."
      return 1
    else
      echo "${service} is running."
    fi
  done
}

main() {
  set -euo pipefail
  case "$OPERATION" in
    install)
      # Runs before the package is installed for the first time.
      check_ubuntu_version
      check_dependencies
      ;;
    upgrade)
      # Runs before upgrading the package to a new version.
      check_ubuntu_version
      check_dependencies
      ;;
    abort-upgrade)
      # Used if an upgrade fails and needs rollback steps.
      ;;
    abort-install)
      # Runs if the initial installation is interrupted or fails.
      ;;
  esac
}

main "$@"
