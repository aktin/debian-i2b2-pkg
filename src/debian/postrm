#!/bin/bash
#--------------------------------------
# Script Name:  postrm
# Version:      1.0
# Author:       skurka@ukaachen.de, shuening@ukaachen.de, akombeiz@ukaachen.de
# Date:         25 Oct 24
# Purpose:      Post-removal script for 'aktin-notaufnahme-i2b2' package that handles
#               cleaning up system configurations and data after package removal or purge.
#--------------------------------------

set -euo pipefail

readonly OPERATION="${1}"

deactivate_php_curl_extension() {
  echo "Disabling Apache2 PHP cURL extension..."
  sed -i "s/extension=curl/;extension=curl/g" /etc/php/*/apache2/php.ini || true
  echo "Restarting Apache2..."
  systemctl restart apache2 || true
}

delete_wildfly_remnants() {
  echo "Deleting WildFly remnants..."
  rm -rf /opt/wildfly/standalone/{tmp,configuration,data,log}
  rm -f /opt/wildfly/standalone/deployments/*.{deployed,failed,isdeploying,pending}
  rm -f /opt/wildfly/standalone/deployments/{crc,im,ont,pm,work}-ds.xml
  echo "WildFly remnants deleted."
}

delete_wildfly_user() {
  echo "Deleting WildFly user..."
  if id -u wildfly >/dev/null 2>&1; then
    deluser --remove-home wildfly
    echo "WildFly user deleted."
  else
    echo "WildFly user does not exist."
  fi
}

drop_i2b2_database() {
  echo "Dropping i2b2 PostgreSQL database and user..."
  eval "sudo -u postgres psql -v ON_ERROR_STOP=1" <<EOF >/dev/null
__I2B2_DROP__

EOF
}

main() {
  case "$OPERATION" in
    remove)
      deactivate_php_curl_extension
      enable_psql_updates
      delete_wildfly_remnants
      delete_wildfly_user
      ;;
    purge)
      drop_i2b2_database
      ;;
  esac
}

main
