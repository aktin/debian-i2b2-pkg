#!/bin/bash
#--------------------------------------
# Script Name:  prerm
# Version:      1.1
# Author:       skurka@ukaachen.de, shuening@ukaachen.de, akombeiz@ukaachen.de
# Date:         30 Oct 24
# Purpose:      Pre-removal script for 'aktin-notaufnahme-i2b2'.
#               Executes before files are deleted or package is upgraded.
#--------------------------------------

readonly OPERATION="${1}"

stop_services() {
  local services=("wildfly" "postgresql" "apache2")
  for service in "${services[@]}"; do
    if systemctl is-active --quiet "${service}"; then
      echo "Stopping ${service} service..."
      systemctl stop "${service}"
    else
      echo "${service} service is already stopped."
    fi
  done
}

backup_wildfly_logs() {
  local log_dir="/opt/wildfly/standalone/log"
  local backup_dir="/usr/share/${DPKG_MAINTSCRIPT_PACKAGE}/backups/wildfly_logs"

  mkdir -p "${backup_dir}"
  # Copy all logs to backup directory
  if [ -d "${log_dir}" ]; then
    echo "Backing up WildFly logs from ${log_dir} to ${backup_dir}..."
    cp -r "${log_dir}/"*.log "${backup_dir}/"
  else
    echo "No WildFly logs found to back up."
  fi
}

main() {
  set -euo pipefail
  case "$OPERATION" in
    remove)
      # Run before the package is removed.
      stop_services
      ;;
    upgrade)
      # Run before upgrading the package to a new version.
      stop_services
      backup_wildfly_logs
      ;;
    deconfigure)
      # Used when the packageâ€™s dependencies are being removed.
      ;;
  esac
}

main "$@"
